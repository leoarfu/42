<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEOAF Command Center</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>

body {
    margin:0;
    font-family:'Inter', sans-serif;
    background: radial-gradient(circle at top, #111827 0%, #05060a 70%);
    color:#e6edf3;
}

/* Subtle star drift */
body::before {
    content:"";
    position:fixed;
    width:200%;
    height:200%;
    background-image: radial-gradient(white 1px, transparent 1px);
    background-size:180px 180px;
    opacity:0.05;
    animation: drift 120s linear infinite;
}

@keyframes drift {
    from { transform: translate(0,0); }
    to { transform: translate(-400px,-400px); }
}

header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:24px 40px;
    border-bottom:1px solid rgba(255,255,255,0.08);
}

header h2 {
    font-family:'Orbitron';
    letter-spacing:2px;
    font-size:20px;
    margin:0;
}

.email {
    font-size:13px;
    opacity:0.6;
}

button {
    background:transparent;
    border:1px solid #ff004f;
    color:#ff004f;
    padding:6px 14px;
    font-family:'Orbitron';
    cursor:pointer;
    transition:0.2s ease;
}

button:hover {
    background:#ff004f;
    color:black;
}

.container {
    max-width:900px;
    margin:40px auto;
    padding:0 20px;
}

/* Progress */
.progress-wrapper {
    margin-bottom:40px;
}

.progress-bar {
    height:10px;
    background:#111;
    border-radius:10px;
    overflow:hidden;
}

.progress-fill {
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#ff004f,#00d9ff);
    transition:0.4s ease;
}

/* Sections */
.section {
    border:1px solid rgba(255,255,255,0.08);
    padding:20px;
    margin-bottom:18px;
    background:rgba(255,255,255,0.02);
}

.section h3 {
    margin:0 0 10px 0;
    font-size:18px;
}

.section p {
    font-size:14px;
    opacity:0.7;
}

.small-btn {
    font-size:12px;
    margin-right:8px;
    padding:4px 10px;
}

.danger {
    border-color:red;
    color:red;
}
.danger:hover {
    background:red;
    color:black;
}

/* RESET MODAL STYLES */
#resetModal {
    display: none; /* Shown via JS */
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95);
    justify-content: center;
    align-items: center;
    z-index: 100;
}
.reset-container {
    background-color: #111;
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='50' viewBox='0 0 100 50' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 50 L25 10 L50 50 L75 10 L100 50' fill='none' stroke='%23ffffff' stroke-width='2.5' stroke-linecap='square'/%3E%3C/svg%3E");
    background-size: 60px 30px;
    padding: 40px;
    border: 2px solid #39ff14; /* Neon Green Border */
    width: 90%;
    max-width: 400px;
    text-align: center;
    position: relative;
    box-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
}
.reset-container h2 { color: #fff; margin-bottom: 20px; font-size: 18px; letter-spacing: 2px; }
.reset-container input {
    width: 100%; padding: 12px; background: #000; border: 1px solid #39ff14;
    color: #fff; font-family: 'Orbitron', sans-serif; font-size: 16px; margin-bottom: 20px;
}

</style>
</head>
<body>

<header>
    <div>
        <h2>LEOAF Command Center</h2>
        <div class="email" id="userEmail"></div>
    </div>
    <button id="logoutBtn">Exit Command</button>
</header>

<div class="container">

    <div class="progress-wrapper">
        <h3>Learning Progress</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <div id="sections"></div>

    <button class="danger" onclick="resetAll()">Reset Entire Course</button>

</div>

<div id="resetModal">
    <div class="reset-container">
        <h2>UPDATE CREDENTIALS</h2>
        <input id="newPassword" type="password" placeholder="New Password">
        <button id="updatePassBtn" class="twin-peaks-btn" style="font-size: 20px;">UPDATE</button>
        <p id="resetMsg" style="color: #39ff14; margin-top: 15px; font-size: 12px;"></p>
    </div>
</div>
    
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const supabaseUrl = 'https://kpkpptqtuuhnbdntuluc.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwa3BwdHF0dXVobmJkbnR1bHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTE2MjAsImV4cCI6MjA4NjcyNzYyMH0.qUgRlbvjhi_cB7PTmSJLm62YFf3nJyYtJsnqbP97FrM';
const { createClient } = supabase;
const client = createClient(supabaseUrl, supabaseKey);

const sectionsList = [
    "Foundations of Architecture",
    "System Design Principles",
    "Scalability & Distributed Systems",
    "Database Design",
    "Security & Reliability",
    "Architecture Patterns",
    "Performance Optimization",
    "Deployment & DevOps"
];

let currentUser = null;
let progress = {};

document.addEventListener('DOMContentLoaded', async () => {

    const { data: { user } } = await client.auth.getUser();

    if (!user) {
        window.location.href = "index.html";
        return;
    }

    currentUser = user;
    document.getElementById("userEmail").innerText = user.email;

    await loadProgress();
    renderSections();
    updateProgress();

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await client.auth.signOut();
        window.location.href = "index.html";
    });

});

async function loadProgress() {
    const { data, error } = await client
        .from('user_progress')
        .select('*')
        .eq('user_id', currentUser.id);

    if (error) {
        console.error(error);
        return;
    }

    progress = {};
    data.forEach(row => {
        progress[row.section] = row.mastered;
    });
}

function renderSections(){
    const container = document.getElementById("sections");
    container.innerHTML = "";

    sectionsList.forEach(section => {
        const mastered = progress[section];

        const div = document.createElement("div");
        div.className = "section";

        div.innerHTML = `
            <h3>${section}</h3>
            <p>${mastered ? "Section mastered." : "Ready to begin."}</p>
            <button class="small-btn" onclick="toggle('${section}')">
                ${mastered ? "Undo Mastery" : "Mark Mastered"}
            </button>
        `;

        container.appendChild(div);
    });
}

async function toggle(section){

    const mastered = progress[section];

    if (mastered) {
        // Remove mastery
        await client
            .from('user_progress')
            .delete()
            .eq('user_id', currentUser.id)
            .eq('section', section);

        delete progress[section];

    } else {
        // Insert or update
        await client
            .from('user_progress')
            .upsert({
                user_id: currentUser.id,
                section: section,
                mastered: true
            }, { onConflict: ['user_id', 'section'] });

        progress[section] = true;
    }

    renderSections();
    updateProgress();
}

function updateProgress(){
    const completed = Object.values(progress).filter(v => v).length;
    const percent = (completed / sectionsList.length) * 100;
    document.getElementById("progressFill").style.width = percent + "%";
}

const resetModal = document.getElementById('resetModal');
const updatePassBtn = document.getElementById('updatePassBtn');
const newPasswordInput = document.getElementById('newPassword');
const resetMsg = document.getElementById('resetMsg');

// 1. Detect the Reset URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('reset') === 'true') {
    resetModal.style.display = 'flex';
}

// 2. Handle the Update
updatePassBtn.addEventListener('click', async () => {
    const newPass = newPasswordInput.value.trim();
    if (newPass.length < 6) {
        resetMsg.style.color = "#ff004f";
        resetMsg.innerText = "Password must be at least 6 chars.";
        return;
    }

    const { error } = await supabase.auth.updateUser({ password: newPass });

    if (error) {
        resetMsg.style.color = "#ff004f";
        resetMsg.innerText = error.message;
    } else {
        resetMsg.innerText = "PASSWORD UPDATED. REDIRECTING...";
        setTimeout(() => { window.location.href = "dashboard.html"; }, 2000);
    }
});

</script>
</body>
</html>
